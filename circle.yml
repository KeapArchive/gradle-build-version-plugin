machine:
  environment:
  java:
    version: oraclejdk8

dependencies:
  override:
    # Update ~/.ssh/config so it points to the read/write ssh key that is generated by the script in repo devops/circle-ci-envar-script
    - sed -i "s/id_circleci_github/id_infusionsoft/g" ~/.ssh/config
    - "curl -s -H \"Authorization: token ${GITHUB_AUTH_TOKEN}\" https://raw.githubusercontent.com/infusionsoft/circle-ci-docker-scripts/master/init.sh | bash"
    - mkdir -p ~/.gradle && echo "${GRADLE_PROPERTIES}" | base64 --decode > ~/.gradle/gradle.properties

test:
  override:
    - ./gradlew clean check
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex '.*/build/test-results/.*xml' -exec cp {} $CIRCLE_TEST_REPORTS/junit \;
    - find . -path '*/build/reports' | while read dir; do
        TARGET=$CIRCLE_ARTIFACTS/$(dirname $(dirname "${dir}"));
        mkdir -p $TARGET;
        cp -R $dir $TARGET;
      done

deployment:
  production:
    branch: master
    commands:
      - ./gradlew release -DisRelease=true
      - ./gradlew pushTags
